<!DOCTYPE html>
<html>
<head>
    <title>BPMN Схема</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14/dist/assets/bpmn-js.css">
    <script src="https://unpkg.com/bpmn-js@14/dist/bpmn-navigated-viewer.development.js"></script>
    <!-- Иконки Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Шрифт Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3a86ff;
            --primary-hover: #2a76ef;
            --surface-color: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --radius-lg: 16px;
            --radius-md: 12px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            color: var(--text-primary);
            background: #f8fafc;
        }

        /* 1.1 Контейнер схемы */
        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
            background: var(--surface-color);
        }

        #canvas.grabbing {
            cursor: grabbing;
        }

        /* 1.2 Панель управления - единый стиль */
        #controls {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface-color);
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: var(--transition);
        }

        /* 1.3 Кнопки с едиными иконками Material */
        .control-btn {
            width: 44px;
            height: 44px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--text-primary);
            font-size: 0; /* Скрываем текст */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }

        .control-btn .material-icon {
            font-family: 'Material Symbols Rounded';
            font-weight: 400;
            font-size: 22px;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .control-btn:hover {
            border-color: var(--primary-color);
            background: rgba(58, 134, 255, 0.08);
            transform: translateY(-2px);
        }

        .control-btn:hover .material-icon {
            color: var(--primary-color);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -38px;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: rgba(26, 26, 26, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        .control-btn:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 1.4 Индикатор масштаба - единый стиль текста */
        #zoom-indicator {
            margin-left: 16px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: center;
            border: 1.5px solid var(--border-color);
            font-family: 'Inter', sans-serif;
        }

        #zoom-level {
            font-weight: 600;
            color: var(--primary-color);
            font-family: 'Inter', sans-serif;
        }

        /* 1.5 Индикатор загрузки */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--surface-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
            gap: 20px;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 2.5px solid rgba(58, 134, 255, 0.1);
            border-top: 2.5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 1.6 Статус - единый стиль текста */
        #status {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(26, 26, 26, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
            max-width: 300px;
            line-height: 1.5;
        }

        #status.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* 1.7 Адаптивность */
        @media (max-width: 768px) {
            #controls {
                top: 16px;
                padding: 10px 14px;
                gap: 6px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
            }
            
            .control-btn .material-icon {
                font-size: 20px;
            }
            
            #zoom-indicator {
                font-size: 12px;
                min-width: 90px;
                padding: 6px 12px;
                margin-left: 12px;
            }
        }

        @media (max-width: 480px) {
            #controls {
                top: 12px;
                padding: 8px 12px;
                gap: 4px;
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
            }
            
            .control-btn .material-icon {
                font-size: 18px;
            }
            
            .control-btn::after {
                display: none;
            }
            
            #zoom-indicator {
                display: none;
            }
        }

        /* 1.8 Анимации */
        .fade-in {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body>
    <!-- 2.1 Контейнер схемы -->
    <div id="canvas-container">
        <div id="canvas"></div>
        
        <!-- 2.2 Панель управления с едиными иконками -->
        <div id="controls" class="fade-in">
            <button class="control-btn" onclick="F6_1_zoomIn()" data-tooltip="Увеличить (Ctrl +)">
                <span class="material-icon">zoom_in</span>
            </button>
            <button class="control-btn" onclick="F6_2_zoomOut()" data-tooltip="Уменьшить (Ctrl -)">
                <span class="material-icon">zoom_out</span>
            </button>
            <button class="control-btn" onclick="F6_3_resetView()" data-tooltip="Сбросить вид">
                <span class="material-icon">restart_alt</span>
            </button>
            <button class="control-btn" onclick="F6_4_toggleFullscreen()" data-tooltip="Полный экран">
                <span class="material-icon" id="fullscreen-icon">fullscreen</span>
            </button>
            
            <div id="zoom-indicator">
                <span>Масштаб:</span>
                <span id="zoom-level">100%</span>
            </div>
        </div>
        
        <!-- 2.3 Индикатор загрузки -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loader"></div>
            <div class="loading-text">Загрузка схемы...</div>
        </div>
        
        <!-- 2.4 Статус -->
        <div id="status"></div>
    </div>

    <script>
        // ==================== 3. КОНФИГУРАЦИЯ ====================
        const CONFIG = {
            defaultDiagram: '1zayavka.bpmn',
            zoom: {
                min: 0.1,
                max: 5,
                stepMouse: 0.0008,
                smoothness: 0.15
            }
        };

        // ==================== 4. ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
        let viewer = null;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let currentZoom = 1;
        let currentViewbox = null;
        let resizeTimeout = null;
        let isFullscreen = false;

        // ==================== 5. ФУНКЦИИ ИНИЦИАЛИЗАЦИИ ====================
        
        // 5.1 Инициализация просмотрщика
        function F4_1_initViewer() {
            viewer = new BpmnJS({ 
                container: '#canvas'
            });
            
            F10_1_setupEventListeners();
            F11_1_setupKeyboardShortcuts();
            F12_1_showStatus('Готов к работе', 'success');
        }

        // 5.2 Показать статус
        function F12_1_showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.classList.add('show');
            
            setTimeout(() => {
                status.classList.remove('show');
            }, 2500);
        }

        // ==================== 6. ФУНКЦИИ УПРАВЛЕНИЯ МАСШТАБОМ ====================
        
        // 6.1 Плавный зум относительно курсора
        function F6_1_smoothZoom(targetZoom, clientX, clientY) {
            const canvas = viewer.get('canvas');
            const viewport = canvas.viewbox();
            
            // Точка зума относительно позиции курсора
            const pointX = (clientX - viewport.x) / currentZoom;
            const pointY = (clientY - viewport.y) / currentZoom;
            
            // Ограничиваем целевой масштаб
            const clampedZoom = Math.max(CONFIG.zoom.min, 
                Math.min(CONFIG.zoom.max, targetZoom));
            
            // Плавный переход к новому масштабу
            let startZoom = currentZoom;
            let progress = 0;
            
            const animateZoom = () => {
                progress += CONFIG.zoom.smoothness;
                const easeProgress = 1 - Math.pow(1 - progress, 3); // Кубическое easing
                
                if (progress < 1) {
                    currentZoom = startZoom + (clampedZoom - startZoom) * easeProgress;
                    canvas.zoom(currentZoom, { x: pointX, y: pointY });
                    F11_2_updateZoomIndicator();
                    requestAnimationFrame(animateZoom);
                } else {
                    currentZoom = clampedZoom;
                    canvas.zoom(currentZoom, { x: pointX, y: pointY });
                    F11_2_updateZoomIndicator();
                }
            };
            
            animateZoom();
        }

        // 6.2 Увеличить (кнопка +)
        function F6_1_zoomIn() {
            const targetZoom = currentZoom * 1.25;
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            F6_1_smoothZoom(targetZoom, canvasRect.width / 2, canvasRect.height / 2);
        }
        
        // 6.3 Уменьшить (кнопка -)
        function F6_2_zoomOut() {
            const targetZoom = currentZoom * 0.8;
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            F6_1_smoothZoom(targetZoom, canvasRect.width / 2, canvasRect.height / 2);
        }
        
        // 6.4 Сбросить вид к исходному
        function F6_3_resetView() {
            viewer.get('canvas').zoom('fit-viewport', { 
                padding: { 
                    top: 60, 
                    bottom: 60, 
                    left: 60, 
                    right: 60 
                } 
            });
            currentZoom = viewer.get('canvas').zoom();
            F11_2_updateZoomIndicator();
            F12_1_showStatus('Вид сброшен', 'info');
        }
        
        // 6.5 Переключение полноэкранного режима
        function F6_4_toggleFullscreen() {
            const elem = document.documentElement;
            
            if (!document.fullscreenElement) {
                // Сохраняем текущее состояние перед переходом в полноэкранный режим
                saveViewState();
                elem.requestFullscreen().then(() => {
                    isFullscreen = true;
                    document.getElementById('fullscreen-icon').textContent = 'fullscreen_exit';
                    // В полноэкранном режиме сохраняем масштаб и позицию
                    setTimeout(() => {
                        restoreViewState();
                    }, 100);
                });
            } else {
                // Сохраняем состояние перед выходом
                saveViewState();
                document.exitFullscreen().then(() => {
                    isFullscreen = false;
                    document.getElementById('fullscreen-icon').textContent = 'fullscreen';
                    // После выхода восстанавливаем сохраненное состояние
                    setTimeout(() => {
                        restoreViewState();
                    }, 100);
                });
            }
        }

        // ==================== 7. СОХРАНЕНИЕ И ВОССТАНОВЛЕНИЕ СОСТОЯНИЯ ====================
        
        // 7.1 Сохранить текущее состояние просмотра
        function saveViewState() {
            const canvas = viewer.get('canvas');
            currentViewbox = canvas.viewbox();
            // Сохраняем текущий zoom отдельно
            currentZoom = canvas.zoom();
        }
        
        // 7.2 Восстановить сохраненное состояние
        function restoreViewState() {
            if (!currentViewbox) return;
            
            const canvas = viewer.get('canvas');
            try {
                // Восстанавливаем позицию и масштаб
                canvas.viewbox(currentViewbox);
                // Убеждаемся, что zoom соответствует сохраненному
                canvas.zoom(currentZoom);
                F11_2_updateZoomIndicator();
            } catch (e) {
                console.warn('Не удалось восстановить состояние:', e);
            }
        }

        // ==================== 8. ФУНКЦИИ ЗАГРУЗКИ СХЕМЫ ====================
        
        // 8.1 Загрузка схемы
        async function F5_1_loadDiagram() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');
            
            const urlParams = new URLSearchParams(window.location.search);
            const diagramFileName = urlParams.get('diagram') || CONFIG.defaultDiagram;
            
            try {
                const response = await fetch(diagramFileName);
                if (!response.ok) throw new Error(`Файл не найден`);
                
                const xml = await response.text();
                await viewer.importXML(xml);
                
                // Исходная настройка вида
                setTimeout(() => {
                    F6_3_resetView();
                    loadingOverlay.classList.add('hidden');
                    F12_1_showStatus(`Схема "${diagramFileName}" загружена`, 'success');
                }, 600);
                
            } catch (error) {
                loadingOverlay.classList.add('hidden');
                F12_1_showStatus(`Ошибка загрузки: ${error.message}`, 'error');
                console.error('Ошибка загрузки:', error);
            }
        }

        // ==================== 9. ОБРАБОТКА КОЛЕСИКА И ПЕРЕТАСКИВАНИЯ ====================
        
        // 9.1 Обработка колесика мыши
        function F9_1_handleWheel(e) {
            e.preventDefault();
            
            const delta = -Math.sign(e.deltaY) * CONFIG.zoom.stepMouse;
            const targetZoom = currentZoom * (1 + delta * 3);
            
            F6_1_smoothZoom(targetZoom, e.clientX, e.clientY);
        }

        // 9.2 Начать перетаскивание
        function F7_1_startDrag(clientX, clientY) {
            isDragging = true;
            lastMouseX = clientX;
            lastMouseY = clientY;
            document.getElementById('canvas').classList.add('grabbing');
        }
        
        // 9.3 Перетаскивание
        function F7_2_doDrag(clientX, clientY) {
            if (!isDragging) return;
            
            const dx = clientX - lastMouseX;
            const dy = clientY - lastMouseY;
            
            const canvas = viewer.get('canvas');
            canvas.scroll({ dx: -dx, dy: -dy });
            
            lastMouseX = clientX;
            lastMouseY = clientY;
            
            // Сохраняем состояние при перетаскивании
            saveViewState();
        }
        
        // 9.4 Закончить перетаскивание
        function F7_3_endDrag() {
            isDragging = false;
            document.getElementById('canvas').classList.remove('grabbing');
        }

        // ==================== 10. ОБРАБОТЧИКИ СОБЫТИЙ ====================
        
        // 10.1 Настройка обработчиков
        function F10_1_setupEventListeners() {
            const canvas = document.getElementById('canvas');
            
            // Мышь
            canvas.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    F7_1_startDrag(e.clientX, e.clientY);
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                F7_2_doDrag(e.clientX, e.clientY);
            });
            
            document.addEventListener('mouseup', F7_3_endDrag);
            
            // Колесико
            canvas.addEventListener('wheel', F9_1_handleWheel, { passive: false });
            
            // Изменение размера окна - БЕЗ сброса, только восстановление
            window.addEventListener('resize', () => {
                if (resizeTimeout) clearTimeout(resizeTimeout);
                
                // Ждем окончания изменения размера
                resizeTimeout = setTimeout(() => {
                    if (currentViewbox) {
                        restoreViewState();
                    }
                }, 150);
            });
            
            // Полноэкранный режим - обновление иконки
            document.addEventListener('fullscreenchange', () => {
                isFullscreen = !!document.fullscreenElement;
                document.getElementById('fullscreen-icon').textContent = 
                    isFullscreen ? 'fullscreen_exit' : 'fullscreen';
                
                // При изменении полноэкранного режима сохраняем состояние
                setTimeout(() => {
                    if (currentViewbox) {
                        restoreViewState();
                    }
                }, 100);
            });
        }

        // ==================== 11. ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================
        
        // 11.1 Горячие клавиши
        function F11_1_setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl + + для увеличения
                if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                    e.preventDefault();
                    F6_1_zoomIn();
                }
                
                // Ctrl + - для уменьшения
                if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                    e.preventDefault();
                    F6_2_zoomOut();
                }
                
                // 0 для сброса
                if (e.key === '0') {
                    e.preventDefault();
                    F6_3_resetView();
                }
                
                // F11 для полноэкранного режима
                if (e.key === 'F11') {
                    e.preventDefault();
                    F6_4_toggleFullscreen();
                }
            });
        }
        
        // 11.2 Обновление индикатора масштаба
        function F11_2_updateZoomIndicator() {
            const zoomPercent = Math.round(currentZoom * 100);
            document.getElementById('zoom-level').textContent = `${zoomPercent}%`;
            
            // Анимация изменения
            const indicator = document.getElementById('zoom-level');
            indicator.style.transform = 'scale(1.1)';
            setTimeout(() => {
                indicator.style.transform = 'scale(1)';
            }, 200);
        }

        // ==================== 12. ЗАПУСК ====================
        
        // 12.1 Запуск приложения
        function F12_1_startApplication() {
            F4_1_initViewer();
            F5_1_loadDiagram();
        }

        // 12.2 Запуск при загрузке
        document.addEventListener('DOMContentLoaded', F12_1_startApplication);
    </script>
</body>
</html>
