<script>
        // ===== КОНФИГУРАЦИЯ =====
        const CONFIG = {
            defaultDiagram: '1zayavka.bpmn',
            zoom: {
                min: 0.05,
                max: 20,
                step: 0.2,
                wheelSensitivity: 0.001
            },
            padding: 40
        };

        // ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====
        let viewer = null;
        let currentZoom = 1;

        // ===== ИНИЦИАЛИЗАЦИЯ =====
        function initViewer() {
            viewer = new BpmnJS({
                container: '#canvas'
            });

            setupEventListeners();
        }

        // ===== МАСШТАБИРОВАНИЕ КОЛЁСИКОМ (ИСПРАВЛЕННОЕ) =====
        function handleWheel(e) {
            e.preventDefault();

            const canvas = viewer.get('canvas');
            const viewbox = canvas.viewbox();

            // Координаты курсора относительно видимой области схемы
            const cursorXInDiagram = viewbox.x + (e.clientX / currentZoom);
            const cursorYInDiagram = viewbox.y + (e.clientY / currentZoom);

            // Определяем изменение масштаба
            const zoomFactor = CONFIG.zoom.wheelSensitivity;
            const scrollIntensity = Math.min(Math.abs(e.deltaY), 200) / 100;
            const zoomDelta = (e.deltaY > 0 ? -1 : 1) * zoomFactor * scrollIntensity * 10;

            // Вычисляем новый масштаб
            const targetZoom = currentZoom * (1 + zoomDelta);
            const newZoom = Math.max(CONFIG.zoom.min, Math.min(CONFIG.zoom.max, targetZoom));

            // Вычисляем новые координаты видимой области
            const scaleRatio = newZoom / currentZoom;
            const newViewboxX = cursorXInDiagram - (e.clientX / newZoom);
            const newViewboxY = cursorYInDiagram - (e.clientY / newZoom);

            // Применяем изменения
            canvas.zoom(newZoom);
            canvas.viewbox({
                x: newViewboxX,
                y: newViewboxY,
                width: viewbox.width,
                height: viewbox.height
            });

            // Обновляем глобальную переменную
            currentZoom = newZoom;
            updateZoomIndicator();
        }

        // ===== УПРАВЛЕНИЕ МАСШТАБОМ (КНОПКИ) =====
        function zoomIn() {
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            zoomToPoint(CONFIG.zoom.step, canvasRect.width / 2, canvasRect.height / 2);
        }

        function zoomOut() {
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            zoomToPoint(-CONFIG.zoom.step, canvasRect.width / 2, canvasRect.height / 2);
        }

        // Вспомогательная функция для зума в точку (используется кнопками)
        function zoomToPoint(zoomDelta, clientX, clientY) {
            const canvas = viewer.get('canvas');
            const viewbox = canvas.viewbox();

            const cursorXInDiagram = viewbox.x + (clientX / currentZoom);
            const cursorYInDiagram = viewbox.y + (clientY / currentZoom);

            const targetZoom = currentZoom * (1 + zoomDelta);
            const newZoom = Math.max(CONFIG.zoom.min, Math.min(CONFIG.zoom.max, targetZoom));

            const scaleRatio = newZoom / currentZoom;
            const newViewboxX = cursorXInDiagram - (clientX / newZoom);
            const newViewboxY = cursorYInDiagram - (clientY / newZoom);

            canvas.zoom(newZoom);
            canvas.viewbox({
                x: newViewboxX,
                y: newViewboxY,
                width: viewbox.width,
                height: viewbox.height
            });

            currentZoom = newZoom;
            updateZoomIndicator();
        }

        function resetView() {
            viewer.get('canvas').zoom('fit-viewport', {
                padding: CONFIG.padding
            });
            currentZoom = viewer.get('canvas').zoom();
            updateZoomIndicator();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // ===== ПЕРЕТАСКИВАНИЕ (БЫСТРОЕ И ДИНАМИЧНОЕ) =====
        function setupDragging() {
            const canvas = document.getElementById('canvas');
            let isDragging = false;
            let lastX = 0;
            let lastY = 0;

            canvas.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    isDragging = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    canvas.classList.add('grabbing');
                    e.preventDefault();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const dx = e.clientX - lastX;
                const dy = e.clientY - lastY;

                // Ключевое исправление: скорость перетаскивания НЕ зависит от масштаба!
                const speedMultiplier = 1.0 / Math.sqrt(currentZoom); // Обратная зависимость от масштаба

                viewer.get('canvas').scroll({
                    dx: -dx * speedMultiplier,
                    dy: -dy * speedMultiplier
                });

                lastX = e.clientX;
                lastY = e.clientY;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.classList.remove('grabbing');
            });

            // Отключаем выделение текста при перетаскивании
            canvas.addEventListener('dragstart', (e) => e.preventDefault());
        }

        // ===== ЗАГРУЗКА СХЕМЫ =====
        async function loadDiagram() {
            const urlParams = new URLSearchParams(window.location.search);
            const diagramFileName = urlParams.get('diagram') || CONFIG.defaultDiagram;

            try {
                const response = await fetch(diagramFileName);
                if (!response.ok) throw new Error('Файл не найден');

                const xml = await response.text();
                await viewer.importXML(xml);

                // Начальная настройка
                setTimeout(resetView, 100);

            } catch (error) {
                console.error('Ошибка загрузки:', error);
                document.getElementById('canvas').innerHTML =
                    `<div style="padding: 40px; text-align: center; color: #666;">
                        <h3>Не удалось загрузить схему</h3>
                        <p>Файл "${diagramFileName}" не найден</p>
                    </div>`;
            }
        }

        // ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====
        function updateZoomIndicator() {
            const zoomPercent = Math.round(currentZoom * 100);
            document.getElementById('zoom-level').textContent = `${zoomPercent}%`;
        }

        function setupEventListeners() {
            const canvas = document.getElementById('canvas');

            // Колесико
            canvas.addEventListener('wheel', handleWheel, { passive: false });

            // Перетаскивание
            setupDragging();

            // Полноэкранный режим
            document.addEventListener('fullscreenchange', () => {
                setTimeout(resetView, 50);
            });

            // Горячие клавиши
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === '+' || e.key === '=') {
                        e.preventDefault();
                        zoomIn();
                    } else if (e.key === '-') {
                        e.preventDefault();
                        zoomOut();
                    }
                }

                if (e.key === '0') {
                    e.preventDefault();
                    resetView();
                }

                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });
        }

        // ===== ЗАПУСК =====
        async function start() {
            initViewer();
            await loadDiagram();
        }

        document.addEventListener('DOMContentLoaded', start);
    </script>
