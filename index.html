<!DOCTYPE html>
<html>
<head>
    <title>BPMN Схема</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@14/dist/assets/bpmn-js.css">
    <script src="https://unpkg.com/bpmn-js@14/dist/bpmn-navigated-viewer.development.js"></script>
    <style>
        html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; }
        #canvas { width:100%; height:100%; background:#f8f8f8; }
        #controls {
            position: absolute; top:15px; left:15px;
            background:white; padding:10px; border-radius:5px;
            box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:100;
        }
        button { margin:0 5px; padding:8px 12px; cursor:pointer; }
    </style>
</head>
<body>
    <div id="canvas"></div>
    <div id="controls">
        <button onclick="zoomIn()">+ Увеличить</button>
        <button onclick="zoomOut()">- Уменьшить</button>
        <button onclick="resetView()">Сбросить вид</button>
        <button onclick="enterFullscreen()">На весь экран</button>
        <span style="margin-left:10px; color:#666;" id="status">Загрузка...</span>
    </div>

    <script>
        // 1. Инициализируем просмотрщик
        const viewer = new BpmnJS({
            container: document.getElementById('canvas')
        });

        // 2. Получаем имя файла из параметра ?diagram= в ссылке
        const urlParams = new URLSearchParams(window.location.search);
        const diagramFileName = urlParams.get('diagram') || '1zayavka.bpmn';

        // 3. Функция загрузки схемы
        async function loadDiagram() {
            const statusElement = document.getElementById('status');
            statusElement.textContent = `Загрузка: ${diagramFileName}...`;

            try {
                const response = await fetch(diagramFileName);
                if (!response.ok) {
                    throw new Error(`Файл не найден (ошибка ${response.status})`);
                }
                const xml = await response.text();
                await viewer.importXML(xml);
                statusElement.textContent = `Схема загружена: ${diagramFileName}`;
                viewer.get('canvas').zoom('fit-viewport');
            } catch (error) {
                console.error('Ошибка загрузки схемы:', error);
                statusElement.textContent = 'Ошибка загрузки';
                document.getElementById('canvas').innerHTML = `
                    <div style="padding:30px; text-align:center; color:#d00;">
                        <h3>Не удалось загрузить схему</h3>
                        <p>${error.message}</p>
                        <p>Проверьте:<br>
                        1. Файл <strong>${diagramFileName}</strong> в репозитории<br>
                        2. Правильность имени файла в ссылке</p>
                    </div>
                `;
            }
        }

        // 4. Функции управления
        function zoomIn() { viewer.get('zoomScroll').stepZoom(0.2); }
        function zoomOut() { viewer.get('zoomScroll').stepZoom(-0.2); }
        function resetView() { viewer.get('canvas').zoom('fit-viewport'); }
        function enterFullscreen() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            }
        }

        // 5. Загружаем схему при старте
        window.addEventListener('DOMContentLoaded', loadDiagram);
        
        // 6. Масштабирование колесиком мыши
        document.getElementById('canvas').addEventListener('wheel', function(event) {
            // Отменяем стандартное действие браузера (скролл страницы)
            event.preventDefault();
            
            // Определяем направление прокрутки
            // deltaY > 0 - прокрутка вниз (уменьшение)
            // deltaY < 0 - прокрутка вверх (увеличение)
            const zoomStep = 0.05; // Шаг масштабирования (можно настроить)
            const delta = -event.deltaY; // Инвертируем для привычного поведения
            
            // Применяем масштабирование
            if (delta > 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });
    </script>
</body>
</html>
